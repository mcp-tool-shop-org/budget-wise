<Page
    x:Class="NextLedger.App.Views.Settings.SettingsPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d">

    <Grid x:Name="RootGrid" Padding="24" RowDefinitions="Auto,*" RowSpacing="16" MaxWidth="1000" HorizontalAlignment="Center">
        <!-- Header -->
        <StackPanel Orientation="Horizontal" Spacing="12">
            <TextBlock Text="Settings" FontSize="28" FontWeight="SemiBold" />
        </StackPanel>

        <!-- Tabs -->
        <Pivot Grid.Row="1">
            <!-- Accounts Tab -->
            <PivotItem Header="Accounts">
                <ScrollViewer Padding="0,16,0,0">
                    <StackPanel Spacing="24">
                        <!-- Net Worth Summary -->
                        <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="8" Padding="16">
                            <Grid ColumnDefinitions="*,*,*,*" RowDefinitions="Auto,Auto,Auto" ColumnSpacing="24" RowSpacing="8">
                                <!-- Row 0: Title -->
                                <TextBlock Text="Net Worth Overview" Style="{StaticResource SubtitleTextBlockStyle}" Grid.ColumnSpan="4" />

                                <!-- Row 1: Main metrics -->
                                <StackPanel Grid.Row="1">
                                    <TextBlock Text="Net Worth" FontSize="12" Opacity="0.7" />
                                    <TextBlock Text="{Binding NetWorthText}" FontSize="20" FontWeight="Bold" />
                                </StackPanel>
                                <StackPanel Grid.Row="1" Grid.Column="1">
                                    <TextBlock Text="Total Assets" FontSize="12" Opacity="0.7" />
                                    <TextBlock Text="{Binding TotalAssetsText}" FontSize="16" Foreground="ForestGreen" />
                                </StackPanel>
                                <StackPanel Grid.Row="1" Grid.Column="2">
                                    <TextBlock Text="Total Liabilities" FontSize="12" Opacity="0.7" />
                                    <TextBlock Text="{Binding TotalLiabilitiesText}" FontSize="16" Foreground="Tomato" />
                                </StackPanel>
                                <StackPanel Grid.Row="1" Grid.Column="3" Visibility="{Binding HasXrpAccounts, Converter={StaticResource BoolToVisibilityConverter}}">
                                    <StackPanel Orientation="Horizontal" Spacing="4">
                                        <TextBlock Text="XRP (External)" FontSize="12" Opacity="0.7" />
                                        <FontIcon Glyph="&#xE72E;" FontSize="10" Opacity="0.5" ToolTipService.ToolTip="Externally tracked, read-only" />
                                    </StackPanel>
                                    <TextBlock Text="{Binding XrpTotalText}" FontSize="16" />
                                </StackPanel>

                                <!-- Row 2: Budget breakdown -->
                                <StackPanel Grid.Row="2" Grid.ColumnSpan="2" Orientation="Horizontal" Spacing="16">
                                    <StackPanel Orientation="Horizontal" Spacing="4">
                                        <TextBlock Text="On Budget:" FontSize="12" Opacity="0.7" />
                                        <TextBlock Text="{Binding TotalOnBudgetText}" FontSize="12" />
                                    </StackPanel>
                                    <StackPanel Orientation="Horizontal" Spacing="4">
                                        <TextBlock Text="Off Budget:" FontSize="12" Opacity="0.7" />
                                        <TextBlock Text="{Binding TotalOffBudgetText}" FontSize="12" />
                                    </StackPanel>
                                </StackPanel>
                            </Grid>
                        </Border>

                        <!-- New Account Form -->
                        <StackPanel Spacing="12">
                            <TextBlock Text="Add Account" Style="{StaticResource SubtitleTextBlockStyle}" />
                            <Grid ColumnDefinitions="*,140,120,100,Auto" ColumnSpacing="12" RowDefinitions="Auto,Auto" RowSpacing="8">
                                <TextBox PlaceholderText="Account name" Text="{Binding NewAccountName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                                <ComboBox Grid.Column="1" ItemsSource="{Binding AccountTypes}" SelectedItem="{Binding NewAccountType, Mode=TwoWay}"
                                          HorizontalAlignment="Stretch">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding}" />
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                                <TextBox Grid.Column="2" PlaceholderText="Balance" Text="{Binding NewAccountBalance, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                                <CheckBox Grid.Column="3" Content="On Budget" IsChecked="{Binding NewAccountOnBudget, Mode=TwoWay}" VerticalAlignment="Center" />
                                <Button Grid.Column="4" Content="Add" Command="{Binding CreateAccountCommand}" Style="{StaticResource AccentButtonStyle}" />
                            </Grid>
                        </StackPanel>

                        <!-- Active Accounts List -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="Active Accounts" Style="{StaticResource SubtitleTextBlockStyle}" />
                            <InfoBar IsOpen="True" IsClosable="False" Severity="Informational"
                                     Title="No accounts yet" Message="Add your first account above."
                                     Visibility="{Binding Accounts, Converter={StaticResource CollectionEmptyToVisibilityConverter}}" />

                            <ListView ItemsSource="{Binding Accounts}" SelectionMode="None">
                                <ListView.ItemContainerStyle>
                                    <Style TargetType="ListViewItem">
                                        <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                                        <Setter Property="Padding" Value="0" />
                                        <Setter Property="Margin" Value="0,2" />
                                    </Style>
                                </ListView.ItemContainerStyle>
                                <ListView.ItemTemplate>
                                    <DataTemplate>
                                        <Grid ColumnDefinitions="*,120,100,Auto,Auto" ColumnSpacing="12" Padding="12,8"
                                              Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}" CornerRadius="6">
                                            <StackPanel>
                                                <TextBlock Text="{Binding Name}" FontWeight="SemiBold" />
                                                <TextBlock Text="{Binding TypeDisplayName}" FontSize="12" Opacity="0.6" />
                                            </StackPanel>
                                            <TextBlock Grid.Column="1" Text="{Binding BalanceText}" VerticalAlignment="Center" HorizontalAlignment="Right" />
                                            <TextBlock Grid.Column="2" Text="{Binding IsOnBudget, Converter={StaticResource BoolToOnOffBudgetConverter}}"
                                                       VerticalAlignment="Center" Opacity="0.7" />
                                            <Button Grid.Column="3" Content="Edit" Command="{Binding DataContext.StartEditAccountCommand, ElementName=RootGrid}"
                                                    CommandParameter="{Binding}" />
                                            <Button Grid.Column="4" Content="Close" Command="{Binding DataContext.CloseAccountCommand, ElementName=RootGrid}"
                                                    CommandParameter="{Binding}" ToolTipService.ToolTip="Close this account (can be reopened later)" />
                                        </Grid>
                                    </DataTemplate>
                                </ListView.ItemTemplate>
                            </ListView>
                        </StackPanel>

                        <!-- Closed Accounts -->
                        <StackPanel Spacing="8" Visibility="{Binding HasClosedAccounts, Converter={StaticResource BoolToVisibilityConverter}}">
                            <StackPanel Orientation="Horizontal" Spacing="12">
                                <TextBlock Text="Closed Accounts" Style="{StaticResource SubtitleTextBlockStyle}" VerticalAlignment="Center" />
                                <ToggleSwitch IsOn="{Binding ShowClosedAccounts, Mode=TwoWay}" OnContent="Show" OffContent="Hidden" />
                            </StackPanel>

                            <ListView ItemsSource="{Binding ClosedAccounts}" SelectionMode="None"
                                      Visibility="{Binding ShowClosedAccounts, Converter={StaticResource BoolToVisibilityConverter}}">
                                <ListView.ItemContainerStyle>
                                    <Style TargetType="ListViewItem">
                                        <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                                        <Setter Property="Padding" Value="0" />
                                        <Setter Property="Margin" Value="0,2" />
                                    </Style>
                                </ListView.ItemContainerStyle>
                                <ListView.ItemTemplate>
                                    <DataTemplate>
                                        <Grid ColumnDefinitions="*,120,Auto" ColumnSpacing="12" Padding="12,8"
                                              Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}" CornerRadius="6" Opacity="0.7">
                                            <StackPanel>
                                                <TextBlock Text="{Binding Name}" FontWeight="SemiBold" />
                                                <TextBlock Text="{Binding TypeDisplayName}" FontSize="12" Opacity="0.6" />
                                            </StackPanel>
                                            <TextBlock Grid.Column="1" Text="{Binding BalanceText}" VerticalAlignment="Center" HorizontalAlignment="Right" />
                                            <Button Grid.Column="2" Content="Reopen" Command="{Binding DataContext.ReopenAccountCommand, ElementName=RootGrid}"
                                                    CommandParameter="{Binding}" />
                                        </Grid>
                                    </DataTemplate>
                                </ListView.ItemTemplate>
                            </ListView>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </PivotItem>

            <!-- XRPL Tab -->
            <PivotItem Header="XRPL">
                <ScrollViewer Padding="0,16,0,0">
                    <StackPanel Spacing="24">
                        <!-- XRPL Explanation Banner -->
                        <InfoBar IsOpen="True" IsClosable="False" Severity="Informational"
                                 Title="View-Only External Ledger"
                                 Message="Track public XRPL addresses to view on-chain balances. NextLedger cannot move, send, or sign XRP transactions — it only observes what happens on-chain." />

                        <!-- Track New XRPL Address Form -->
                        <StackPanel Spacing="12">
                            <TextBlock Text="Track XRPL Address" Style="{StaticResource SubtitleTextBlockStyle}" />
                            <Grid ColumnDefinitions="*,180,120,Auto" ColumnSpacing="12">
                                <TextBox PlaceholderText="Display name" Text="{Binding NewXrplName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                                <TextBox Grid.Column="1" PlaceholderText="r-address (rXXX...)" Text="{Binding NewXrplAddress, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                                <ComboBox Grid.Column="2" ItemsSource="{Binding XrplNetworks}" SelectedItem="{Binding NewXrplNetwork, Mode=TwoWay}"
                                          HorizontalAlignment="Stretch" />
                                <Button Grid.Column="3" Content="Track" Command="{Binding TrackXrplAddressCommand}" Style="{StaticResource AccentButtonStyle}" />
                            </Grid>
                        </StackPanel>

                        <!-- XRPL Network Status -->
                        <StackPanel Spacing="8">
                            <StackPanel Orientation="Horizontal" Spacing="12">
                                <TextBlock Text="Network Status" Style="{StaticResource SubtitleTextBlockStyle}" VerticalAlignment="Center" />
                                <Button Content="Refresh" Command="{Binding RefreshXrplStatusCommand}" Padding="8,4" />
                            </StackPanel>
                            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8" Padding="12,8"
                                  Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}" CornerRadius="6">
                                <FontIcon Glyph="{Binding XrplStatusIcon}" FontSize="16" VerticalAlignment="Center" />
                                <TextBlock Grid.Column="1" Text="{Binding XrplStatusMessage}" VerticalAlignment="Center" TextWrapping="Wrap" />
                            </Grid>
                        </StackPanel>

                        <!-- Tracked XRPL Accounts -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="Tracked Addresses" Style="{StaticResource SubtitleTextBlockStyle}" />
                            <InfoBar IsOpen="True" IsClosable="False" Severity="Informational"
                                     Title="No addresses tracked" Message="Add an XRPL r-address above to start tracking."
                                     Visibility="{Binding XrplAccounts, Converter={StaticResource CollectionEmptyToVisibilityConverter}}" />

                            <ListView ItemsSource="{Binding XrplAccounts}" SelectionMode="None">
                                <ListView.ItemContainerStyle>
                                    <Style TargetType="ListViewItem">
                                        <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                                        <Setter Property="Padding" Value="0" />
                                        <Setter Property="Margin" Value="0,4" />
                                    </Style>
                                </ListView.ItemContainerStyle>
                                <ListView.ItemTemplate>
                                    <DataTemplate>
                                        <Grid ColumnDefinitions="*,Auto,Auto,Auto" RowDefinitions="Auto,Auto" ColumnSpacing="8" RowSpacing="4" Padding="12,10"
                                              Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}" CornerRadius="6">
                                            <!-- Row 0: Name + Balance + Buttons -->
                                            <TextBlock Text="{Binding Name}" FontWeight="SemiBold" FontSize="15" />
                                            <TextBlock Grid.Column="1" Text="{Binding BalanceText}" FontWeight="SemiBold" FontSize="15"
                                                       VerticalAlignment="Center" HorizontalAlignment="Right" />
                                            <Button Grid.Column="2" Content="View" Padding="8,4"
                                                    Command="{Binding DataContext.ViewXrplAccountDetailCommand, ElementName=RootGrid}"
                                                    CommandParameter="{Binding}"
                                                    ToolTipService.ToolTip="View on-chain transaction history" />
                                            <Button Grid.Column="3" Content="Sync" Padding="8,4"
                                                    Command="{Binding DataContext.SyncXrplAccountCommand, ElementName=RootGrid}"
                                                    CommandParameter="{Binding}"
                                                    ToolTipService.ToolTip="Fetch latest balance from XRPL" />

                                            <!-- Row 1: Address + Network -->
                                            <StackPanel Grid.Row="1" Grid.ColumnSpan="4" Orientation="Horizontal" Spacing="8">
                                                <TextBlock Text="{Binding ExternalAddress}" FontSize="12" Opacity="0.7" FontFamily="Consolas" />
                                                <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" Padding="6,2" CornerRadius="4">
                                                    <TextBlock Text="{Binding ExternalNetwork}" FontSize="11" Opacity="0.8" />
                                                </Border>
                                            </StackPanel>
                                        </Grid>
                                    </DataTemplate>
                                </ListView.ItemTemplate>
                            </ListView>
                        </StackPanel>

                        <!-- XRPL Account Detail Panel (Transaction Timeline) -->
                        <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="8" Padding="16"
                                Visibility="{Binding IsXrplDetailVisible, Converter={StaticResource BoolToVisibilityConverter}}">
                            <StackPanel Spacing="12">
                                <!-- Header with Actions -->
                                <Grid ColumnDefinitions="*,Auto,Auto">
                                    <StackPanel>
                                        <TextBlock Text="On-Chain Activity" Style="{StaticResource SubtitleTextBlockStyle}" />
                                        <TextBlock Text="{Binding SelectedXrplAccount.Name}" FontSize="13" Opacity="0.7" />
                                    </StackPanel>
                                    <Button Grid.Column="1" Content="Plan Transfer" Command="{Binding ShowTransferIntentCommand}" Padding="8,4"
                                            Style="{StaticResource AccentButtonStyle}" Margin="0,0,8,0"
                                            ToolTipService.ToolTip="Create a transfer plan (NextLedger will NOT execute it)" />
                                    <Button Grid.Column="2" Content="Close" Command="{Binding CloseXrplDetailCommand}" Padding="8,4" />
                                </Grid>

                                <!-- Reconciliation Status -->
                                <Border Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}" CornerRadius="6" Padding="12">
                                    <StackPanel Spacing="4">
                                        <TextBlock Text="Reconciliation Status" FontWeight="SemiBold" FontSize="13" />
                                        <TextBlock Text="{Binding XrplReconciliationStatus}" TextWrapping="Wrap" FontSize="12" Opacity="0.9" />
                                    </StackPanel>
                                </Border>

                                <!-- Transaction List Header -->
                                <TextBlock Text="Recent Transactions (On-Chain)" FontWeight="SemiBold" FontSize="13" />
                                <TextBlock Text="Read-only view of validated XRPL transactions. NextLedger cannot edit or categorize these."
                                           FontSize="11" Opacity="0.6" />

                                <!-- Loading indicator -->
                                <ProgressRing IsActive="{Binding IsLoadingXrplDetail}" Width="24" Height="24"
                                              Visibility="{Binding IsLoadingXrplDetail, Converter={StaticResource BoolToVisibilityConverter}}" />

                                <!-- Transaction List -->
                                <ListView ItemsSource="{Binding XrplTransactions}" SelectionMode="None" MaxHeight="300">
                                    <ListView.ItemContainerStyle>
                                        <Style TargetType="ListViewItem">
                                            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                                            <Setter Property="Padding" Value="0" />
                                            <Setter Property="Margin" Value="0,2" />
                                        </Style>
                                    </ListView.ItemContainerStyle>
                                    <ListView.ItemTemplate>
                                        <DataTemplate>
                                            <Grid ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto,Auto" ColumnSpacing="8" RowSpacing="2"
                                                  Padding="10,8" Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}" CornerRadius="4">
                                                <!-- Row 0: Icon + Summary + Amount -->
                                                <FontIcon Glyph="{Binding CategoryIcon}" FontSize="14" VerticalAlignment="Center" />
                                                <TextBlock Grid.Column="1" Text="{Binding Summary}" FontSize="12" TextTrimming="CharacterEllipsis" />
                                                <TextBlock Grid.Column="2" Text="{Binding AmountText}"
                                                           FontSize="12" FontWeight="SemiBold" HorizontalAlignment="Right" />

                                                <!-- Row 1: Timestamp + Hash (text only, link handled in code) -->
                                                <StackPanel Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="2" Orientation="Horizontal" Spacing="12">
                                                    <TextBlock Text="{Binding TimestampText}" FontSize="10" Opacity="0.6" />
                                                    <TextBlock Text="View on XRPL Explorer →" FontSize="10" Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}" />
                                                </StackPanel>
                                            </Grid>
                                        </DataTemplate>
                                    </ListView.ItemTemplate>
                                </ListView>

                                <!-- Empty state -->
                                <TextBlock Text="No transactions found. The account may be new or not yet activated."
                                           FontSize="12" Opacity="0.6" TextAlignment="Center"
                                           Visibility="{Binding XrplTransactions, Converter={StaticResource CollectionEmptyToVisibilityConverter}}" />
                            </StackPanel>
                        </Border>

                        <!-- ========== Transfer Intent Dialog ========== -->
                        <!-- This is a PLAN, not an execution. NextLedger never signs or submits. -->
                        <Border Background="{ThemeResource AcrylicBackgroundFillColorDefaultBrush}" CornerRadius="8" Padding="20"
                                BorderBrush="{ThemeResource AccentFillColorDefaultBrush}" BorderThickness="2"
                                Visibility="{Binding IsTransferIntentVisible, Converter={StaticResource BoolToVisibilityConverter}}">
                            <StackPanel Spacing="16" MaxWidth="500">
                                <!-- Header -->
                                <StackPanel>
                                    <TextBlock Text="Plan XRP Transfer" Style="{StaticResource SubtitleTextBlockStyle}" />
                                    <TextBlock Text="Create a transfer plan. NextLedger will NOT execute this — you'll do that in your wallet."
                                               FontSize="12" Opacity="0.7" TextWrapping="Wrap" />
                                </StackPanel>

                                <!-- From (read-only) -->
                                <StackPanel Spacing="4">
                                    <TextBlock Text="From" FontSize="12" Opacity="0.7" />
                                    <Border Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}" CornerRadius="4" Padding="12,8">
                                        <StackPanel>
                                            <TextBlock Text="{Binding SelectedXrplAccount.Name}" FontWeight="SemiBold" />
                                            <TextBlock Text="{Binding SelectedXrplAccount.ExternalAddress}" FontSize="11" FontFamily="Consolas" Opacity="0.7" />
                                            <TextBlock Text="{Binding SelectedXrplAccount.BalanceText}" FontSize="13" Opacity="0.9" />
                                        </StackPanel>
                                    </Border>
                                </StackPanel>

                                <!-- To -->
                                <StackPanel Spacing="4">
                                    <TextBlock Text="Destination Address *" FontSize="12" Opacity="0.7" />
                                    <TextBox PlaceholderText="r-address (rXXX...)"
                                             Text="{Binding TransferDestinationAddress, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                             FontFamily="Consolas" />
                                </StackPanel>

                                <!-- Amount -->
                                <StackPanel Spacing="4">
                                    <TextBlock Text="Amount (XRP) *" FontSize="12" Opacity="0.7" />
                                    <TextBox PlaceholderText="0.000000"
                                             Text="{Binding TransferAmountXrp, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                                </StackPanel>

                                <!-- Destination Tag (optional) -->
                                <StackPanel Spacing="4">
                                    <TextBlock Text="Destination Tag (optional — required for exchanges)" FontSize="12" Opacity="0.7" />
                                    <TextBox PlaceholderText="e.g., 12345"
                                             Text="{Binding TransferDestinationTag, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                                </StackPanel>

                                <!-- User Note (optional) -->
                                <StackPanel Spacing="4">
                                    <TextBlock Text="Your Note (optional — stored locally)" FontSize="12" Opacity="0.7" />
                                    <TextBox PlaceholderText="Why are you making this transfer?"
                                             Text="{Binding TransferUserNote, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                             TextWrapping="Wrap" AcceptsReturn="True" Height="60" />
                                </StackPanel>

                                <!-- Validate Button -->
                                <Button Content="Preview Transfer" Command="{Binding ValidateTransferIntentCommand}"
                                        Style="{StaticResource AccentButtonStyle}" HorizontalAlignment="Stretch" />

                                <!-- ========== Validation Preview (Future Ledger) ========== -->
                                <Border Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}" CornerRadius="6" Padding="16"
                                        Visibility="{Binding HasIntentValidation, Converter={StaticResource BoolToVisibilityConverter}}">
                                    <StackPanel Spacing="12">
                                        <!-- Status -->
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <FontIcon Glyph="{Binding IntentIsValid, Converter={StaticResource BoolToValidationIconConverter}}"
                                                      FontSize="16" Foreground="{Binding IntentIsValid, Converter={StaticResource BoolToValidationColorConverter}}" />
                                            <TextBlock Text="{Binding IntentValidationMessage}" FontWeight="SemiBold"
                                                       Foreground="{Binding IntentIsValid, Converter={StaticResource BoolToValidationColorConverter}}" />
                                        </StackPanel>

                                        <!-- Balance Preview (the "Future Ledger" moment) -->
                                        <StackPanel>
                                            <TextBlock Text="Balance Preview" FontWeight="SemiBold" FontSize="13" Margin="0,0,0,8" />
                                            <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="4">
                                                <TextBlock Text="Current Balance:" FontSize="12" />
                                                <TextBlock Grid.Column="1" Text="{Binding IntentCurrentBalance}" FontSize="12" />

                                                <TextBlock Grid.Row="1" Text="Estimated Fee:" FontSize="12" Opacity="0.8" />
                                                <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding IntentEstimatedFee}" FontSize="12" Opacity="0.8" />

                                                <TextBlock Grid.Row="2" Text="After Transfer:" FontSize="12" FontWeight="SemiBold" />
                                                <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding IntentProjectedBalance}" FontSize="12" FontWeight="SemiBold" />

                                                <TextBlock Grid.Row="3" Text="Reserve Requirement:" FontSize="12" Opacity="0.8" />
                                                <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding IntentReserveRequirement}" FontSize="12" Opacity="0.8" />
                                            </Grid>
                                        </StackPanel>

                                        <!-- Warnings -->
                                        <ItemsControl ItemsSource="{Binding IntentWarnings}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border Background="{ThemeResource SystemFillColorCautionBackgroundBrush}" CornerRadius="4" Padding="8" Margin="0,2">
                                                        <TextBlock Text="{Binding}" FontSize="12" TextWrapping="Wrap" />
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>

                                        <!-- Action Buttons -->
                                        <Grid ColumnDefinitions="*,*,*" ColumnSpacing="8">
                                            <Button Content="Approve Plan" Command="{Binding ApproveIntentCommand}"
                                                    Style="{StaticResource AccentButtonStyle}"
                                                    IsEnabled="{Binding IntentIsValid}"
                                                    ToolTipService.ToolTip="Save this plan. Execute it externally in your wallet." />
                                            <Button Grid.Column="1" Content="Export" Command="{Binding ExportExecutionPlanCommand}"
                                                    ToolTipService.ToolTip="Copy execution details to clipboard for your wallet." />
                                            <Button Grid.Column="2" Content="Cancel" Command="{Binding CancelTransferIntentCommand}" />
                                        </Grid>

                                        <!-- Reminder -->
                                        <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="4" Padding="8">
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <FontIcon Glyph="&#xE946;" FontSize="14" Opacity="0.7" />
                                                <TextBlock Text="NextLedger will NOT execute this. You must sign and submit in your XRPL wallet."
                                                           FontSize="11" Opacity="0.7" TextWrapping="Wrap" />
                                            </StackPanel>
                                        </Border>
                                    </StackPanel>
                                </Border>

                                <!-- Cancel (when no validation yet) -->
                                <Button Content="Cancel" Command="{Binding CancelTransferIntentCommand}" HorizontalAlignment="Right"
                                        Visibility="{Binding HasIntentValidation, Converter={StaticResource InverseBoolToVisibilityConverter}}" />
                            </StackPanel>
                        </Border>

                        <!-- ========== Intent History (Audit Trail) ========== -->
                        <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="8" Padding="16">
                            <StackPanel Spacing="12">
                                <!-- Header with Refresh -->
                                <Grid ColumnDefinitions="*,Auto">
                                    <StackPanel>
                                        <TextBlock Text="Transfer Plans (Intent History)" Style="{StaticResource SubtitleTextBlockStyle}" />
                                        <TextBlock Text="Audit trail of your XRPL transfer plans — never executed by NextLedger."
                                                   FontSize="12" Opacity="0.7" />
                                    </StackPanel>
                                    <Button Grid.Column="1" Content="Refresh" Command="{Binding LoadIntentHistoryCommand}" Padding="8,4" />
                                </Grid>

                                <!-- Loading -->
                                <ProgressRing IsActive="{Binding IsLoadingIntentHistory}" Width="24" Height="24"
                                              Visibility="{Binding IsLoadingIntentHistory, Converter={StaticResource BoolToVisibilityConverter}}" />

                                <!-- Empty State -->
                                <TextBlock Text="No transfer plans yet. Use 'Plan Transfer' to create your first intent."
                                           FontSize="12" Opacity="0.6" TextAlignment="Center"
                                           Visibility="{Binding IntentHistory, Converter={StaticResource CollectionEmptyToVisibilityConverter}}" />

                                <!-- Intent List -->
                                <ListView ItemsSource="{Binding IntentHistory}" SelectionMode="None" MaxHeight="250">
                                    <ListView.ItemContainerStyle>
                                        <Style TargetType="ListViewItem">
                                            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                                            <Setter Property="Padding" Value="0" />
                                            <Setter Property="Margin" Value="0,2" />
                                        </Style>
                                    </ListView.ItemContainerStyle>
                                    <ListView.ItemTemplate>
                                        <DataTemplate>
                                            <Grid ColumnDefinitions="Auto,*,Auto,Auto" RowDefinitions="Auto,Auto" ColumnSpacing="8" RowSpacing="2"
                                                  Padding="10,8" Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}" CornerRadius="4">
                                                <!-- Row 0: Icon + Summary + Amount + Status -->
                                                <FontIcon Glyph="{Binding StatusIcon}" FontSize="14" VerticalAlignment="Center" />
                                                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding Summary}" FontSize="12" TextTrimming="CharacterEllipsis" />
                                                </StackPanel>
                                                <TextBlock Grid.Column="2" Text="{Binding AmountText}" FontSize="12" FontWeight="SemiBold"
                                                           HorizontalAlignment="Right" VerticalAlignment="Center" />
                                                <Border Grid.Column="3" Padding="6,2" CornerRadius="4" VerticalAlignment="Center"
                                                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}">
                                                    <TextBlock Text="{Binding Status}" FontSize="11" />
                                                </Border>

                                                <!-- Row 1: Type + Timestamps -->
                                                <StackPanel Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="3" Orientation="Horizontal" Spacing="12">
                                                    <TextBlock Text="{Binding IntentType}" FontSize="10" Opacity="0.6" />
                                                    <TextBlock FontSize="10" Opacity="0.6">
                                                        <Run Text="Created:" />
                                                        <Run Text="{Binding CreatedAtText}" />
                                                    </TextBlock>
                                                </StackPanel>
                                            </Grid>
                                        </DataTemplate>
                                    </ListView.ItemTemplate>
                                </ListView>
                            </StackPanel>
                        </Border>

                        <!-- Reserve Explanation -->
                        <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="8" Padding="16">
                            <StackPanel Spacing="8">
                                <TextBlock Text="Understanding XRP Reserve" FontWeight="SemiBold" />
                                <TextBlock TextWrapping="Wrap" FontSize="13" Opacity="0.9"
                                           Text="XRPL requires each account to maintain a minimum reserve. This reserve is not spendable and helps prevent ledger spam." />
                                <TextBlock FontSize="12" Opacity="0.7" Text="• Base reserve: 10 XRP (required to activate account)" />
                                <TextBlock FontSize="12" Opacity="0.7" Text="• Owner reserve: 2 XRP per owned object (trust lines, offers, etc.)" />
                                <Border Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}" CornerRadius="4" Padding="8" Margin="0,8,0,0">
                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                        <FontIcon Glyph="&#xE72E;" FontSize="12" />
                                        <TextBlock Text="NextLedger cannot move your XRP. Use your wallet to send transactions."
                                                   FontSize="11" Opacity="0.8" TextWrapping="Wrap" />
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </PivotItem>

            <!-- Envelopes Tab -->
            <PivotItem Header="Envelopes">
                <ScrollViewer Padding="0,16,0,0">
                    <StackPanel Spacing="24">
                        <!-- New Envelope Form -->
                        <StackPanel Spacing="12">
                            <TextBlock Text="Add Envelope" Style="{StaticResource SubtitleTextBlockStyle}" />
                            <Grid ColumnDefinitions="*,160,Auto,Auto" ColumnSpacing="12">
                                <TextBox PlaceholderText="Envelope name" Text="{Binding NewEnvelopeName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                                <AutoSuggestBox Grid.Column="1" PlaceholderText="Group (optional)" Text="{Binding NewEnvelopeGroup, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                ItemsSource="{Binding GroupNames}" />
                                <ComboBox Grid.Column="2" ItemsSource="{Binding PredefinedColors}" SelectedItem="{Binding NewEnvelopeColor, Mode=TwoWay}" Width="80">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <Border Width="40" Height="20" CornerRadius="4" Background="{Binding}" />
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                                <Button Grid.Column="3" Content="Add" Command="{Binding CreateEnvelopeCommand}" Style="{StaticResource AccentButtonStyle}" />
                            </Grid>
                        </StackPanel>

                        <!-- Active Envelopes List -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="Active Envelopes" Style="{StaticResource SubtitleTextBlockStyle}" />
                            <InfoBar IsOpen="True" IsClosable="False" Severity="Informational"
                                     Title="No envelopes yet" Message="Add your first envelope above."
                                     Visibility="{Binding Envelopes, Converter={StaticResource CollectionEmptyToVisibilityConverter}}" />

                            <ListView ItemsSource="{Binding Envelopes}" SelectionMode="None">
                                <ListView.ItemContainerStyle>
                                    <Style TargetType="ListViewItem">
                                        <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                                        <Setter Property="Padding" Value="0" />
                                        <Setter Property="Margin" Value="0,2" />
                                    </Style>
                                </ListView.ItemContainerStyle>
                                <ListView.ItemTemplate>
                                    <DataTemplate>
                                        <Grid ColumnDefinitions="Auto,*,140,Auto,Auto" ColumnSpacing="12" Padding="12,8"
                                              Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}" CornerRadius="6">
                                            <Border Width="16" Height="16" CornerRadius="8" Background="{Binding Color}" VerticalAlignment="Center" />
                                            <StackPanel Grid.Column="1">
                                                <TextBlock Text="{Binding Name}" FontWeight="SemiBold" />
                                                <TextBlock Text="{Binding GroupName}" FontSize="12" Opacity="0.6"
                                                           Visibility="{Binding GroupName, Converter={StaticResource StringToVisibilityConverter}}" />
                                            </StackPanel>
                                            <TextBlock Grid.Column="2" Text="{Binding GroupName}" VerticalAlignment="Center" Opacity="0.7"
                                                       Visibility="{Binding GroupName, Converter={StaticResource StringToVisibilityConverter}}" />
                                            <Button Grid.Column="3" Content="Edit" Command="{Binding DataContext.StartEditEnvelopeCommand, ElementName=RootGrid}"
                                                    CommandParameter="{Binding}" />
                                            <Button Grid.Column="4" Content="Archive" Command="{Binding DataContext.ArchiveEnvelopeCommand, ElementName=RootGrid}"
                                                    CommandParameter="{Binding}" ToolTipService.ToolTip="Archive this envelope (can be restored later)" />
                                        </Grid>
                                    </DataTemplate>
                                </ListView.ItemTemplate>
                            </ListView>
                        </StackPanel>

                        <!-- Archived Envelopes -->
                        <StackPanel Spacing="8" Visibility="{Binding HasArchivedEnvelopes, Converter={StaticResource BoolToVisibilityConverter}}">
                            <StackPanel Orientation="Horizontal" Spacing="12">
                                <TextBlock Text="Archived Envelopes" Style="{StaticResource SubtitleTextBlockStyle}" VerticalAlignment="Center" />
                                <ToggleSwitch IsOn="{Binding ShowArchivedEnvelopes, Mode=TwoWay}" OnContent="Show" OffContent="Hidden" />
                            </StackPanel>

                            <ListView ItemsSource="{Binding ArchivedEnvelopes}" SelectionMode="None"
                                      Visibility="{Binding ShowArchivedEnvelopes, Converter={StaticResource BoolToVisibilityConverter}}">
                                <ListView.ItemContainerStyle>
                                    <Style TargetType="ListViewItem">
                                        <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                                        <Setter Property="Padding" Value="0" />
                                        <Setter Property="Margin" Value="0,2" />
                                    </Style>
                                </ListView.ItemContainerStyle>
                                <ListView.ItemTemplate>
                                    <DataTemplate>
                                        <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12" Padding="12,8"
                                              Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}" CornerRadius="6" Opacity="0.7">
                                            <Border Width="16" Height="16" CornerRadius="8" Background="{Binding Color}" VerticalAlignment="Center" />
                                            <StackPanel Grid.Column="1">
                                                <TextBlock Text="{Binding Name}" FontWeight="SemiBold" />
                                                <TextBlock Text="{Binding GroupName}" FontSize="12" Opacity="0.6"
                                                           Visibility="{Binding GroupName, Converter={StaticResource StringToVisibilityConverter}}" />
                                            </StackPanel>
                                            <Button Grid.Column="2" Content="Restore" Command="{Binding DataContext.UnarchiveEnvelopeCommand, ElementName=RootGrid}"
                                                    CommandParameter="{Binding}" />
                                        </Grid>
                                    </DataTemplate>
                                </ListView.ItemTemplate>
                            </ListView>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </PivotItem>
        </Pivot>

        <!-- Edit Account Dialog -->
        <ContentDialog x:Name="EditAccountDialog"
                       Title="Edit Account"
                       PrimaryButtonText="Save"
                       PrimaryButtonCommand="{Binding SaveAccountCommand}"
                       CloseButtonText="Cancel"
                       CloseButtonCommand="{Binding CancelEditAccountCommand}"
                       DefaultButton="Primary">
            <StackPanel Spacing="16" MinWidth="320">
                <TextBox Header="Name" Text="{Binding EditAccountName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                <CheckBox Content="On Budget" IsChecked="{Binding EditAccountOnBudget, Mode=TwoWay}" />
            </StackPanel>
        </ContentDialog>

        <!-- Edit Envelope Dialog -->
        <ContentDialog x:Name="EditEnvelopeDialog"
                       Title="Edit Envelope"
                       PrimaryButtonText="Save"
                       PrimaryButtonCommand="{Binding SaveEnvelopeCommand}"
                       CloseButtonText="Cancel"
                       CloseButtonCommand="{Binding CancelEditEnvelopeCommand}"
                       DefaultButton="Primary">
            <StackPanel Spacing="16" MinWidth="320">
                <TextBox Header="Name" Text="{Binding EditEnvelopeName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                <AutoSuggestBox Header="Group" Text="{Binding EditEnvelopeGroup, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                ItemsSource="{Binding GroupNames}" PlaceholderText="(none)" />
                <ComboBox Header="Color" ItemsSource="{Binding PredefinedColors}" SelectedItem="{Binding EditEnvelopeColor, Mode=TwoWay}">
                    <ComboBox.ItemTemplate>
                        <DataTemplate>
                            <Border Width="60" Height="24" CornerRadius="4" Background="{Binding}" />
                        </DataTemplate>
                    </ComboBox.ItemTemplate>
                </ComboBox>
            </StackPanel>
        </ContentDialog>
    </Grid>
</Page>
